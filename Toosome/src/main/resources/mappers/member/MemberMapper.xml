<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.web.toosome.user.member.dao.IMemberMapper">

	<resultMap type="memberVO" id="memberMap">
		<id property="memberId" column="MEMBER_ID"/>
		<result property="memberName" column="MEMBER_NAME"/>
		<result property="memberEmail" column="MEMBER_EMAIL"/>
		<result property="memberPassword" column="MEMBER_PASSWORD"/>
		<result property="memberBirth" column="MEMBER_BIRTH"/>
		<result property="memberPhone" column="MEMBER_PHONE"/>
		<result property="memberAddress" column="MEMBER_ADDRESS"/>
		<result property="platFormType" column="MEMBER_PLATFORM_TYPE"/>
		<result property="regDate" column="MEMBER_REG_DATE"/>
		<result property="status" column="MEMBER_STATUS"/>
		<result property="lastLoginDate" column="MEMBER_LAST_LOGIN_DATE"/>
		<result property="memberRePassword" column="MEMBER_REPASSWORD"/>
		<result property="memberEnabled" column="MEMBER_ENABLED"/>
		<collection property="authList" resultMap="authMap" />
	</resultMap>

	<resultMap type="com.web.toosome.user.member.vo.AuthVO" id="authMap">
		<result property="memberEmail" column="MEMBER_EMAIL" />
		<result property="memberAuth" column="MEMBER_AUTH" />
	</resultMap>

	<!-- 이메일 중복 검증 sql -->
	<select id="emailDupCheck" resultType="int">
		SELECT COUNT(*) FROM MEMBER WHERE MEMBER_EMAIL = #{memberEmail}
	</select>
	
	<!-- 이메일로 회원 조회 -->
	<select id="getUserByEmail" resultMap="memberMap">
		SELECT
		 MEMBER_ID, mem.MEMBER_EMAIL, MEMBER_NAME, MEMBER_PASSWORD, MEMBER_BIRTH, MEMBER_PHONE, MEMBER_ADDRESS, MEMBER_PLATFORM_TYPE, MEMBER_REG_DATE, MEMBER_STATUS, MEMBER_LAST_LOGIN_DATE, MEMBER_REPASSWORD, MEMBER_AUTH
		FROM
		 MEMBER mem LEFT OUTER JOIN MEMBER_AUTH auth on mem.MEMBER_EMAIL = auth.MEMBER_EMAIL
		WHERE mem.MEMBER_EMAIL = #{memberEmail}
	</select>
	
	<!-- 회원 가입 (사용자) -->
	<insert id="registerMember">
		INSERT INTO 
		 MEMBER(MEMBER_NAME, MEMBER_EMAIL, MEMBER_PASSWORD, MEMBER_BIRTH, MEMBER_PHONE, MEMBER_ADDRESS, MEMBER_STATUS, MEMBER_PLATFORM_TYPE)
		VALUES(#{memberName}, #{memberEmail}, #{memberPassword}, #{memberBirth}, #{memberPhone}, #{memberAddress}, 1, #{platFormType})
	</insert>
	<insert id="registerMemberAuth">
		INSERT INTO MEMBER_AUTH
		VALUES(#{email}, 'ROLE_USER')
	</insert>
	<!-- 회원 가입 (관리자) -->
	<insert id="registerAdmin">
		INSERT INTO 
		 MEMBER(MEMBER_NAME, MEMBER_EMAIL, MEMBER_PASSWORD, MEMBER_BIRTH, MEMBER_PHONE, MEMBER_ADDRESS, MEMBER_STATUS)
		VALUES(#{memberName}, #{memberEmail}, #{memberPassword}, 'admin', 'admin', 'admin', 0)
	</insert>
	<insert id="registerAdminAuth">
		INSERT INTO MEMBER_AUTH
		VALUES(#{email}, 'ROLE_ADMIN')
	</insert>

	<!-- 아이디, 비밀번호 찾기 -->
	<select id="getSMS" resultMap="memberMap">
        SELECT MEMBER_NAME FROM MEMBER WHERE MEMBER_PHONE=#{memberPhone}
    </select>
	<select id="getMail" resultMap="memberMap">
		SELECT MEMBER_EMAIL FROM MEMBER WHERE MEMBER_PHONE=#{memberPhone}
	</select>
	<update id="getRepassword" parameterType="memberVO">
		UPDATE MEMBER SET MEMBER_PASSWORD=#{memberPassword} WHERE MEMBER_PHONE=#{memberPhone}
	</update>
	<select id="getPassword" resultMap="memberMap">
		SELECT MEMBER_PASSWORD FROM MEMBER WHERE MEMBER_PHONE=#{memberPhone}
	</select>
</mapper>